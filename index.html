<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ของที่ระลึก JTM Family Trip</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif; 
      margin: 0; 
      padding: 24px; 
      line-height: 1.5; 
      background-color: #f8fafc;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    h1 { margin-bottom: 8px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    label { display: block; font-weight: 600; margin: 12px 0 6px; }
    input[type="text"], select { width: 100%; max-width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
    .items { display: grid; grid-template-columns: 1fr auto; gap: 8px 16px; align-items: center; }
    .item-name { font-size: 14px; }
    .qty { width: 80px; }
    .total { font-size: 18px; font-weight: 700; }
    .hint { color: #64748b; font-size: 13px; }
    .banner { grid-column: 1 / -1; margin: 8px 0; text-align: center; }
    .banner img { width: 100%; max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 12px; object-fit: contain; }
    .error { color: #b91c1c; }
    .success { color: #065f46; }
    button { padding: 12px 18px; border-radius: 10px; border: 0; background:#111827; color: #fff; cursor: pointer; }
    button[disabled]{ opacity: .6; cursor: not-allowed; }
    .footer-note { font-size: 13px; color:#475569; }
    
    @media (max-width: 768px) {
      body { padding: 16px; }
      .container { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ของที่ระลึก JTM Family Trip</h1>
    <p class="hint">กรอกข้อมูลด้านล่างและเลือกจำนวนสินค้าที่ต้องการ </p>
    <p><b> สมนาคุณพิเศษ ทุก 1,000บาท รับสติ๊กเกอร์ JTM (แบบสุ่มลาย) 1แผ่น </b></p>

    <form id="orderForm" enctype="multipart/form-data">
    <!-- Main Input -->
    <div class="card">
      <h3>ข้อมูลผู้สั่งซื้อ</h3>

      <label for="contactName">ระบุชื่อ ศิษย์เก่าหรือศิษย์ปัจจุบัน คนใดคนหนึ่ง เพื่อสะดวกในการติดต่อ เช่น "เอสตั้น"</label>
      <input id="contactName" name="contactName" type="text" required placeholder="ทอคุณ" />

      <label for="batch">ระบุรุ่นตามชื่อที่ระบุในข้อแรก</label>
      <select id="batch" name="batch" required>
        <option value="">-- โปรดเลือก --</option>
        <option>JTM#18</option>
        <option>JTM#19</option>
        <option>JTM#20</option>
        <option>JTM#21</option>
        <option>JTM#22</option>
        <option>JTM#23</option>
        <option>JTM#24</option>
        <option>JTM#25</option>
        <option>JTM#26</option>
        <option>JTM#27</option>
        <option>คุณครู</option>
        <option>อื่นๆ</option>
      </select>

      <label for="batchOther">กรณีรุ่นอื่นๆ โปรดระบุรุ่น</label>
      <input id="batchOther" name="batchOther" type="text" placeholder="ระบุชื่อรุ่น (ถ้ามี)" />
      <p class="hint">* หากเลือก "อื่นๆ" โปรดระบุชื่อรุ่นด้านบน</p>

      <label for="phoneNumber">เบอร์โทรศัพท์สำหรับติดต่อ</label>
      <input id="phoneNumber" name="phoneNumber" type="tel" required placeholder="081-234-5678" pattern="[0-9\-]+" />
      <p class="hint">* กรุณาระบุเบอร์โทรศัพท์เพื่อการติดต่อกลับ</p>
    </div>

    <!-- Shop order (auto from JSON config) -->
    <div class="card">
      <h3>รายการสินค้า</h3>
      <div id="itemsContainer" class="items"></div>
      <hr />
      <div style="display: flex; gap: 32px; align-items: flex-start;">
        <div style="flex: 1;">
          <p class="total">ยอดรวม: <span id="total">0</span> บาท</p>
          <p>รับสินค้าสมนาคุณ <strong><span id="freebies">0</span></strong> ชิ้น (ทุกๆ 1,000 บาท)</p>
        </div>
        <div style="flex: 1; min-width: 0;">
          <h4 style="margin: 0 0 8px 0; color: #374151;">สรุปรายการที่เลือก</h4>
          <div id="orderSummary" style="font-size: 14px; color: #6b7280; max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background-color: #f9fafb;">
            <p style="margin: 0; font-style: italic;">ยังไม่มีรายการที่เลือก</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment slip -->
    <div class="card">
      <h3>อัปโหลดหลักฐานการโอน</h3>
      <div style="text-align: center; max-width: 400px; margin: 0 auto;">
        <!-- Top: Bank Account Info -->
        <div style="margin-bottom: 20px; padding: 16px; background-color: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
          <p style="margin: 0 0 4px 0; font-weight: 600; color: #374151; font-size: 16px;">ข้อมูลบัญชีธนาคาร</p>
          <p style="margin: 0 0 2px 0; font-size: 15px; color: #6b7280;">KBank 020-1-23387-9</p>
          <p style="margin: 0; font-size: 15px; color: #6b7280;">ยศสยา นิธิภัทรารัตน์</p>
        </div>
        
        <!-- Middle: QR Code -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">QR Code สำหรับโอนเงิน</label>
          <img src="qr.jpg" alt="QR Code" style="max-width: 250px; height: auto; border-radius: 8px; border: 1px solid #e5e7eb;" />
          <p class="hint" style="margin-top: 8px; font-size: 12px;">สแกน QR Code เพื่อโอนเงิน</p>
        </div>
        
        <!-- Bottom: File Upload -->
        <div>
          <label for="paymentSlip">อัปโหลดสลิปโอนเงิน (รูปภาพ)</label>
          <input id="paymentSlip" name="paymentSlip" type="file" accept="image/*" required style="margin-top: 8px;" />
          <p class="hint">รองรับไฟล์รูปภาพ</p>
        </div>
      </div>
    </div>

    <div class="card">
      <button id="submitBtn" type="submit">ส่งคำสั่งซื้อ</button>
      <span id="status" style="margin-left:12px;"></span>
      <p class="footer-note">เมื่อส่งแล้ว ระบบจะบันทึกข้อมูลลง Google Sheet และจัดเก็บรูปสลิปใน Google Drive</p>
    </div>
  </form>
  </div>

  <script>
    // ---- JSON CONFIG: สินค้าและราคา ----
    // เพิ่มคุณสมบัติ "disabled: true" เพื่อปิดการใช้งานสินค้ารายนั้น
    const CATALOG = [
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ Deep Navy S", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ Deep Navy M", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ Deep Navy L", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ Deep Navy XL", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ Deep Navy 2XL", price: 300 },

      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ White S", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ White M", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ White L", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ White XL", price: 300 },
      { name: "เสื้อยุงลายทรง Standard ปักโลโก้ - ผู้ใหญ่ White 2XL", price: 300 },

      { name: "เสื้อยุงลายทรง Oversize ปักโลโก้ - ผู้ใหญ่ Female 45'' Deep Navy", price: 350 },
      { name: "เสื้อยุงลายทรง Oversize ปักโลโก้ - ผู้ใหญ่ Male 50'' Deep Navy", price: 350 },
      { name: "เสื้อยุงลายทรง Oversize ปักโลโก้ - ผู้ใหญ่ Female 45'' White", price: 350 },
      { name: "เสื้อยุงลายทรง Oversize ปักโลโก้ - ผู้ใหญ่ Male 50'' White", price: 350 },

      { name: "เสื้อยุงลายปักโลโก้ สำหรับเด็ก 110", price: 220 },
      { name: "เสื้อยุงลายปักโลโก้ สำหรับเด็ก 120", price: 220 },
      { name: "เสื้อยุงลายปักโลโก้ สำหรับเด็ก 130", price: 220 },
      { name: "เสื้อยุงลายปักโลโก้ สำหรับเด็ก 140", price: 220 },
      { name: "เสื้อยุงลายปักโลโก้ สำหรับเด็ก 150", price: 220 },

      { name: "กระเป๋าผ้าทรงเสื้อกล้าม พับเก็บได้ ลายเป็นแบบสุ่มแต่สวยทุกใบ", price: 220 },
      { name: "กระเป๋า Cross Body สีฟ้า", price: 250 },
      { name: "กระเป๋า Cross Body สีเหลือง", price: 250 },
      { name: "กระเป๋า Cross Body สีดำ", price: 250 },

      { name: "หมวกแก๊บผ้าร่ม เด็กใส่ได้ ผู้ใหญ่ใส่ดี - หมวกแก๊ป 3 สี", price: 320 },
      { name: "หมวกแก๊บผ้าร่ม เด็กใส่ได้ ผู้ใหญ่ใส่ดี - หมวกแก๊ปสีเทา - เหลือง", price: 320 },
      { name: "หมวกแก๊บผ้าร่ม เด็กใส่ได้ ผู้ใหญ่ใส่ดี - หมวกแก๊ปสีฟ้า - เขียว", price: 320 },
      { name: "หมวก Bucket ผ้าร่ม", price: 350 },

      { name: "สติกเกอร์ติดท้ายรถ แบบ 1", price: 50 },
      { name: "สติกเกอร์ติดท้ายรถ แบบ 2", price: 50 } //{ name: "สติกเกอร์ติดท้ายรถ แบบ 2", price: 50, disabled: true },
    ];

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx1wYhJEGOrJb3WN5QultwtNpAQSk-sPXpWL54CWWSP-zR63FznkfAJ1lWZZUtadq3Y/exec"; // <-- เปลี่ยนเป็น URL จาก Apps Script

    // Banner configuration: insert an image BEFORE the item at given index
    // You can control image size per banner by adding optional width/maxWidth/height/maxHeight
    // e.g. { index: 10, src: "oversize.jpg", alt: "Oversize", width: "80%", maxHeight: "300px" }
    const BANNERS = [
  { index: 0, src: "standard.jpg", alt: "Standard", maxWidth: "600px" },
  { index: 10, src: "oversize.jpg", alt: "Oversize", width: "90%", maxHeight: "600px" },
  { index: 14, src: "kids.jpg", alt: "Kids", width: "60%" },
  { index: 19, src: "bags.jpg", alt: "Bags", width: "50%", maxWidth: "600px" },
  { index: 20, src: "crossbody.jpg", alt: "Crossbody", width: "50%", maxWidth: "600px" },
  { index: 23, src: "hats.jpg", alt: "Hats", width: "85%" },
  { index: 26, src: "bucket.jpg", alt: "Bucket", width: "85%", maxHeight: "280px" },
  //{ index: 27, src: "stickers.jpg", alt: "Stickers", width: "80%" },
];

    function appendBanner(container, cfg) {
      const wrap = document.createElement("div");
      wrap.className = "banner";
      const img = document.createElement("img");
      img.src = cfg.src;
      img.alt = cfg.alt || "";
      img.loading = "lazy";
      if (cfg.width) img.style.width = cfg.width;
      if (cfg.maxWidth) img.style.maxWidth = cfg.maxWidth;
      if (cfg.height) img.style.height = cfg.height;
      if (cfg.maxHeight) img.style.maxHeight = cfg.maxHeight;
      wrap.appendChild(img);
      container.appendChild(wrap);
    }

    // Render items with banners interleaved
    const itemsContainer = document.getElementById("itemsContainer");
    const bannersByIndex = new Map(BANNERS.map(b => [b.index, b]));
    for (let i = 0; i < CATALOG.length; i++) {
      const maybeBanner = bannersByIndex.get(i);
      if (maybeBanner) appendBanner(itemsContainer, maybeBanner);

      const item = CATALOG[i];
      if (item.disabled) {
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = `qty_${i}`;
        hidden.value = "0";
        itemsContainer.appendChild(hidden);
        continue;
      }

      const nameEl = document.createElement("div");
      nameEl.className = "item-name";
      nameEl.textContent = `${item.name} — ${item.price} บาท`;

      const qtyEl = document.createElement("select");
      qtyEl.className = "qty";
      qtyEl.name = `qty_${i}`;
      for (let n = 0; n <= 10; n++) {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        qtyEl.appendChild(opt);
      }
      qtyEl.addEventListener("change", recalcTotal);
      itemsContainer.appendChild(nameEl);
      itemsContainer.appendChild(qtyEl);
    }

    function recalcTotal() {
      let total = 0;
      const selectedItems = [];
      
      CATALOG.forEach((item, i) => {
        const qty = parseInt(document.querySelector(`[name="qty_${i}"]`).value || "0", 10);
        if (isNaN(qty) || qty < 0 || qty > 10) {
          document.getElementById("status").textContent = "จำนวนต้องเป็นตัวเลข 0–10";
          document.getElementById("status").className = "error";
        }
        total += item.price * qty;
        
        if (qty > 0) {
          selectedItems.push({
            name: item.name,
            quantity: qty,
            price: item.price,
            subtotal: item.price * qty
          });
        }
      });
      
      document.getElementById("total").textContent = total.toLocaleString();
      document.getElementById("freebies").textContent = Math.floor(total / 1000);
      
      // Update order summary
      updateOrderSummary(selectedItems);
    }
    
    function updateOrderSummary(selectedItems) {
      const summaryContainer = document.getElementById("orderSummary");
      
      if (selectedItems.length === 0) {
        summaryContainer.innerHTML = '<p style="margin: 0; font-style: italic;">ยังไม่มีรายการที่เลือก</p>';
        return;
      }
      
      let summaryHTML = '';
      selectedItems.forEach(item => {
        summaryHTML += `
          <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 2px;">${item.name}</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>จำนวน: ${item.quantity} ชิ้น</span>
              <span style="font-weight: 600;">${item.subtotal.toLocaleString()} บาท</span>
            </div>
          </div>
        `;
      });
      
      summaryContainer.innerHTML = summaryHTML;
    }

    const form = document.getElementById("orderForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusSpan = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // basic validation
      if (document.getElementById("batch").value === "อื่นๆ" && !document.getElementById("batchOther").value.trim()) {
        statusSpan.textContent = "โปรดระบุรุ่น (เมื่อเลือก 'อื่นๆ')";
        statusSpan.className = "error";
        return;
      }

      // Validate quantities (0–10)
      for (let i = 0; i < CATALOG.length; i++) {
        const v = parseInt(document.querySelector(`[name="qty_${i}"]`).value || "0", 10);
        if (isNaN(v) || v < 0 || v > 10) {
          statusSpan.textContent = "จำนวนต้องเป็นตัวเลข 0–10";
          statusSpan.className = "error";
          return;
        }
      }

      // Build FormData (multipart) so we can include the image file
      const fd = new FormData();
      fd.set("contactName", document.getElementById("contactName").value.trim());
      fd.set("batch", document.getElementById("batch").value);
      fd.set("batchOther", document.getElementById("batchOther").value.trim());
      fd.set("phoneNumber", document.getElementById("phoneNumber").value.trim());
      fd.set("catalogLength", String(CATALOG.length));

      // include current total (server will re-check)
      fd.set("clientTotal", document.getElementById("total").textContent.replace(/,/g, ""));

      // For each item, send its qty by index (server-side catalog must match)
      for (let i = 0; i < CATALOG.length; i++) {
        fd.set(`qty_${i}`, document.querySelector(`[name="qty_${i}"]`).value);
      }

      const file = document.getElementById("paymentSlip").files[0];
      if (!file) {
        statusSpan.textContent = "โปรดอัปโหลดรูปสลิปโอนเงิน";
        statusSpan.className = "error";
        return;
      }
      // Always include base64 fallback so server can decode if e.files is undefined
      try {
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        const base64 = String(dataUrl).split(",")[1] || "";
        fd.set("paymentSlipName", file.name);
        fd.set("paymentSlipType", file.type || "application/octet-stream");
        fd.set("paymentSlipBase64", base64);
      } catch (readErr) {
        // If base64 conversion fails, we still try sending the raw file
      }
      fd.set("paymentSlip", file, file.name);

      submitBtn.disabled = true;
      statusSpan.textContent = "กำลังส่งข้อมูล...";
      statusSpan.className = "";

      try {
        const res = await fetch(WEB_APP_URL, { method: "POST", body: fd });
        const msg = await res.text();
        if (res.ok) {
          statusSpan.textContent = "ส่งข้อมูลสำเร็จ ขอบคุณค่ะ/ครับ!";
          statusSpan.className = "success";
          form.reset();
          recalcTotal();
        } else {
          statusSpan.textContent = `เกิดข้อผิดพลาด: ${msg}`;
          statusSpan.className = "error";
        }
      } catch (err) {
        statusSpan.textContent = `ส่งไม่สำเร็จ: ${err.message}`;
        statusSpan.className = "error";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // initial total
    recalcTotal();
  </script>
</body>
</html>