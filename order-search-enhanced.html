<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JTM Shop - Order Search (Enhanced)</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif; 
      margin: 0; 
      padding: 24px; 
      line-height: 1.5; 
      background-color: #f8fafc;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    h1 { margin-bottom: 8px; color: #1f2937; }
    .search-section {
      background-color: #f9fafb;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid #e5e7eb;
    }
    .search-row {
      display: flex;
      gap: 16px;
      align-items: end;
      margin-bottom: 16px;
    }
    .search-group {
      flex: 1;
    }
    label { 
      display: block; 
      font-weight: 600; 
      margin-bottom: 6px; 
      color: #374151;
    }
    input[type="text"], select { 
      width: 100%; 
      padding: 10px; 
      border: 1px solid #cbd5e1; 
      border-radius: 8px; 
      font-size: 14px;
      transition: all 0.2s;
    }
    input[type="text"]:disabled, select:disabled { 
      background-color: #f3f4f6; 
      color: #9ca3af; 
      cursor: not-allowed;
    }
    button { 
      padding: 12px 24px; 
      border-radius: 8px; 
      border: 0; 
      background: #111827; 
      color: #fff; 
      cursor: pointer; 
      font-weight: 600;
      transition: background-color 0.2s;
    }
    button:hover {
      background: #1f2937;
    }
    button:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      background: #9ca3af;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .error {
      color: #dc2626;
      background-color: #fef2f2;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      margin-bottom: 16px;
    }
    .success {
      color: #059669;
      background-color: #f0fdf4;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #bbf7d0;
      margin-bottom: 16px;
    }
    .order-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      background-color: white;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .order-info {
      flex: 1;
    }
    .order-name {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .order-details {
      color: #6b7280;
      font-size: 14px;
    }
    .order-total {
      font-size: 20px;
      font-weight: 700;
      color: #059669;
    }
    .core-team-badge {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .order-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .item-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      background-color: #f9fafb;
    }
    .item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .item-info {
      flex: 1;
    }
    .item-name {
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .item-quantity {
      color: #059669;
      font-weight: 600;
      font-size: 16px;
    }
    .no-results {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    }


    
    @media (max-width: 768px) {
      body { padding: 16px; }
      .container { padding: 20px; }
      .search-row { flex-direction: column; }
      .order-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .order-items { grid-template-columns: 1fr; }
      .stats { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç JTM Shop - Order Search (Enhanced)</h1>
    <p style="color: #6b7280; margin-bottom: 24px;">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å Google Sheets - Order Data Tab - ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á</p>

    <!-- Search Section -->
    <div class="search-section">
      <div class="search-row">
        <div class="search-group">
          <label for="batchFilter">‡∏£‡∏∏‡πà‡∏ô (Batch)</label>
          <select id="batchFilter" disabled>
            <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∏‡πà‡∏ô</option>
            <option value="JTM#18">JTM#18</option>
            <option value="JTM#19">JTM#19</option>
            <option value="JTM#20">JTM#20</option>
            <option value="JTM#21">JTM#21</option>
            <option value="JTM#22">JTM#22</option>
            <option value="JTM#23">JTM#23</option>
            <option value="JTM#24">JTM#24</option>
            <option value="JTM#25">JTM#25</option>
            <option value="JTM#26">JTM#26</option>
            <option value="JTM#27">JTM#27</option>
            <option value="‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
        <div class="search-group">
          <label for="nameSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠</label>
          <input id="nameSearch" type="text" placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." disabled />
        </div>
        <div class="search-group">
          <button id="searchBtn" onclick="searchOrders()" disabled>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
      </div>
      <div class="search-row">
        <div class="search-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="coreTeamFilter" style="width: auto; margin: 0;" disabled>
            ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Core Team (‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
          </label>
        </div>
        <div class="search-group">
          <button id="clearBtn" onclick="clearSearch()" disabled>üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
      </div>
      <div id="searchStatus" style="text-align: center; color: #6b7280; font-style: italic; margin-top: 16px;">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage"></div>

    <!-- Results Section -->
    <div id="resultsSection"></div>
  </div>

  <script>
    // Google Sheets URL - you need to publish this as CSV
    // To publish: File > Share > Publish to web > CSV
    // Reading from "Order Data" tab instead of main sheet
    const SHEETS_URL = "https://docs.google.com/spreadsheets/d/19RzNl-aSOvQ0DRSAo4pjm3YcF4FdEqPl37rOtmu8CIY/edit?gid=1646323390#gid=1646323390";
    
    // CORS Proxy (you can use any of these or set up your own)
    const CORS_PROXIES = [
      "https://cors-anywhere.herokuapp.com/",
      "https://api.allorigins.win/raw?url=",
      "https://corsproxy.io/?",
      "https://thingproxy.freeboard.io/fetch/"
    ];
    
    // Product catalog with images
    const PRODUCT_CATALOG = [
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy S", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy M", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy L", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy XL", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy 2XL", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà White S", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà White M", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà White L", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà White XL", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà White 2XL", image: "standard.png", price: 300 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Oversize ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Female 45'' Deep Navy", image: "oversize.png", price: 350 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Oversize ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Male 50'' Deep Navy", image: "oversize.png", price: 350 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Oversize ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Female 45'' White", image: "oversize.png", price: 350 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Oversize ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Male 50'' White", image: "oversize.png", price: 350 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å 110", image: "kids.jpg", price: 220 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å 120", image: "kids.jpg", price: 220 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å 130", image: "kids.jpg", price: 220 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å 140", image: "kids.jpg", price: 220 },
      { name: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å 150", image: "kids.jpg", price: 220 },
      { name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤‡∏ó‡∏£‡∏á‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡πâ‡∏≤‡∏°", image: "bags.jpg", price: 220 },
      { name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡∏ü‡πâ‡∏≤", image: "crossbody.jpg", price: 250 },
      { name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", image: "crossbody.jpg", price: 250 },
      { name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡∏î‡∏≥", image: "crossbody.jpg", price: 250 },
      { name: "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ 3 ‡∏™‡∏µ", image: "hats.jpg", price: 320 },
      { name: "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ - ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", image: "hats.jpg", price: 320 },
      { name: "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", image: "hats.jpg", price: 320 },
      { name: "‡∏´‡∏°‡∏ß‡∏Å Bucket ‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏°", image: "bucket.jpg", price: 350 },
      { name: "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 1", image: "sticker1.jpg", price: 50 },
      { name: "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 2", image: "sticker2.jpg", price: 50 }
    ];

    let allOrders = [];
    let filteredOrders = [];

    // Enable search controls after data is loaded
    function enableSearchControls() {
      document.getElementById('batchFilter').disabled = false;
      document.getElementById('nameSearch').disabled = false;
      document.getElementById('nameSearch').placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
      document.getElementById('searchBtn').disabled = false;
      document.getElementById('coreTeamFilter').disabled = false;
      document.getElementById('clearBtn').disabled = false;
      document.getElementById('searchStatus').innerHTML = '‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ';
    }

    // Disable search controls during loading
    function disableSearchControls() {
      document.getElementById('batchFilter').disabled = true;
      document.getElementById('nameSearch').disabled = true;
      document.getElementById('nameSearch').placeholder = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
      document.getElementById('searchBtn').disabled = true;
      document.getElementById('coreTeamFilter').disabled = true;
      document.getElementById('clearBtn').disabled = true;
      document.getElementById('searchStatus').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
    }

    // Convert Google Sheets URL to CSV export URL
    function getCSVUrl(sheetsUrl) {
      // Extract the sheet ID and tab ID from the URL
      const sheetMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      const tabMatch = sheetsUrl.match(/gid=(\d+)/);
      
      if (!sheetMatch) {
        throw new Error('Invalid Google Sheets URL');
      }
      
      const sheetId = sheetMatch[1];
      const tabId = tabMatch ? tabMatch[1] : '0'; // Default to first tab if no gid specified
      
      // Use the specific tab ID for CSV export
      return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${tabId}`;
    }

    // Load data from Google Sheets using CORS proxy
    async function loadDataFromSheets() {
      const statusDiv = document.getElementById('statusMessage');
      const resultsDiv = document.getElementById('resultsSection');
      
      // Disable search controls during loading
      disableSearchControls();
      
      statusDiv.innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</div>';
      resultsDiv.innerHTML = '';

      try {
        const csvUrl = getCSVUrl(SHEETS_URL);
        let csvData = null;
        
        // Try different CORS proxies
        for (let i = 0; i < CORS_PROXIES.length; i++) {
          try {
            const proxyUrl = CORS_PROXIES[i] + encodeURIComponent(csvUrl);
            console.log(`Trying proxy ${i + 1}: ${CORS_PROXIES[i]}`);
            
            const response = await fetch(proxyUrl, {
              method: 'GET',
              headers: {
                'Accept': 'text/csv,text/plain,*/*'
              }
            });
            
            if (response.ok) {
              csvData = await response.text();
              console.log('Successfully loaded data from proxy:', CORS_PROXIES[i]);
              break;
            }
          } catch (proxyError) {
            console.log(`Proxy ${i + 1} failed:`, proxyError);
            continue;
          }
        }
        
        if (!csvData) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
        }
        
        // Parse CSV data
        const orders = parseCSVData(csvData);
        allOrders = orders;
        
        // Get the total data rows count for summary
        const totalDataRows = csvData.split('\n').length - 1; // Exclude header row
        
        statusDiv.innerHTML = '<div class="success">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ' + allOrders.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
        
        // Show all orders initially
        displayOrders(allOrders);
        
        // Enable search controls after successful data load
        enableSearchControls();
        
      } catch (error) {
        console.error('Error loading data:', error);
        statusDiv.innerHTML = '<div class="error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message + '<br><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...</div>';
        
        // Fallback to sample data
        setTimeout(() => {
          const sampleData = generateSampleData();
          allOrders = sampleData;
          displayOrders(allOrders);
          statusDiv.innerHTML = '<div class="success">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ' + allOrders.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
          
          // Enable search controls after sample data is loaded
          enableSearchControls();
        }, 1000);
      }
    }

    // Parse CSV data from Google Sheets
    function parseCSVData(csvText) {
      console.log('=== CSV PARSING DEBUG START ===');
      console.log('Raw CSV data length:', csvText.length);
      console.log('Raw CSV preview (first 1000 chars):', csvText.substring(0, 1000));
      
      const lines = csvText.split('\n');
      console.log('Total CSV lines:', lines.length);
      
      if (lines.length < 2) {
        throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
      
      // Parse headers (first row)
      const headers = parseCSVRow(lines[0]);
      console.log('CSV Headers:', headers);
      console.log('Number of columns:', headers.length);
      
      // Show all available columns for reference
      console.log('üìã Available columns for mapping:');
      headers.forEach((header, index) => {
        console.log(`  ${index}: "${header}"`);
      });
      
      // Also show a more detailed analysis of what each column might contain
      console.log('üîç Column Analysis:');
      headers.forEach((header, index) => {
        const lowerHeader = header.toLowerCase();
        let type = 'Unknown';
        if (lowerHeader.includes('time') || lowerHeader.includes('date') || lowerHeader.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà')) type = 'Timestamp';
        else if (lowerHeader.includes('name') || lowerHeader.includes('‡∏ä‡∏∑‡πà‡∏≠') || lowerHeader.includes('contact')) type = 'Contact Name';
        else if (lowerHeader.includes('phone') || lowerHeader.includes('‡πÄ‡∏ö‡∏≠‡∏£‡πå') || lowerHeader.includes('tel')) type = 'Phone Number';
        else if (lowerHeader.includes('batch') || lowerHeader.includes('‡∏£‡∏∏‡πà‡∏ô') || lowerHeader.includes('model')) type = 'Batch';
        else if (lowerHeader.includes('total') || lowerHeader.includes('‡∏¢‡∏≠‡∏î') || lowerHeader.includes('‡∏£‡∏≤‡∏Ñ‡∏≤')) type = 'Total Amount';
        else if (lowerHeader.includes('sticker')) type = 'Stickers';
        else if (lowerHeader.includes('core') || lowerHeader.includes('team')) type = 'Core Team';
        else if (lowerHeader.includes('slip') || lowerHeader.includes('‡∏™‡∏•‡∏¥‡∏õ')) type = 'Payment Slip';
        else if (lowerHeader.includes('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô') || lowerHeader.includes('quantity')) type = 'Quantity';
        
        console.log(`  ${index}: "${header}" ‚Üí ${type}`);
      });
      
      // Suggest column mappings based on common patterns
      console.log('üí° Suggested column mappings:');
      const suggestedMappings = {
        'timestamp': headers.find(h => h.toLowerCase().includes('time') || h.toLowerCase().includes('date')),
        'contact name': headers.find(h => h.toLowerCase().includes('name') || h.toLowerCase().includes('contact')),
        'batch': headers.find(h => h.toLowerCase().includes('batch')),
        'phone number': headers.find(h => h.toLowerCase().includes('phone') || h.toLowerCase().includes('tel')),
        'total baht': headers.find(h => h.toLowerCase().includes('total') && h.toLowerCase().includes('baht')),
        'free stickers': headers.find(h => h.toLowerCase().includes('sticker')),
        'core team': headers.find(h => h.toLowerCase().includes('core') || h.toLowerCase().includes('team'))
      };
      
      Object.entries(suggestedMappings).forEach(([key, value]) => {
        if (value) {
          console.log(`  ${key}: "${value}"`);
        }
      });
      
      // Debug: Show last few headers to identify Core Team columns
      console.log('Last 10 headers:', headers.slice(-10));
      console.log('Headers that might contain Core Team info:');
      headers.forEach((header, index) => {
        if (header.toLowerCase().includes('core') || header.toLowerCase().includes('team') || header.toLowerCase().includes('‡∏ï‡∏¥‡∏î‡∏•‡∏ö')) {
          console.log(`  Header ${index}: "${header}"`);
        }
      });
      
      const orders = [];
      let skippedRows = 0;
      let emptyRows = 0;
      let insufficientColumns = 0;
      let noItemsRows = 0;
      let successfulRows = 0;
      let totalDataRows = lines.length - 1; // Exclude header row
      
      // Parse data rows (skip header)
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) {
          emptyRows++;
          continue;
        }
        
        const values = parseCSVRow(line);
        
        if (values.length < headers.length) {
          console.log(`Row ${i}: Insufficient columns (${values.length} < ${headers.length}) - Values:`, values);
          insufficientColumns++;
          continue;
        }
        
        // Create a helper function to get values by column name
        const getValueByColumn = (columnName, defaultValue = '') => {
          // First try exact match
          let columnIndex = headers.findIndex(header => 
            header.toLowerCase().trim() === columnName.toLowerCase().trim()
          );
          
          // If no exact match, try partial match
          if (columnIndex === -1) {
            columnIndex = headers.findIndex(header => 
              header.toLowerCase().includes(columnName.toLowerCase()) ||
              columnName.toLowerCase().includes(header.toLowerCase())
            );
          }
          
          if (columnIndex >= 0) {
            return values[columnIndex];
          } else {
            return defaultValue;
          }
        };

        const getNumericValueByColumn = (columnName, defaultValue = 0) => {
          const value = getValueByColumn(columnName, '');
          if (value === '') return defaultValue;
          return parseFloat(value.replace(/,/g, '')) || defaultValue;
        };

        const getIntValueByColumn = (columnName, defaultValue = 0) => {
          const value = getValueByColumn(columnName, '');
          if (value === '') return defaultValue;
          return parseInt(value) || defaultValue;
        };

        // Try multiple possible column names for each field
        const order = {
          timestamp: getValueByColumn('Timestamp') || getValueByColumn('Date') || getValueByColumn('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || getValueByColumn('Time'),
          contactName: getValueByColumn('Contact Name') || getValueByColumn('Name') || getValueByColumn('‡∏ä‡∏∑‡πà‡∏≠') || getValueByColumn('Contact'),
          batch: getValueByColumn('Batch') || getValueByColumn('‡∏£‡∏∏‡πà‡∏ô') || getValueByColumn('Model'),
          batchOther: getValueByColumn('Batch Other') || getValueByColumn('‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô') || getValueByColumn('Other'),
          phoneNumber: getValueByColumn('Phone Number') || getValueByColumn('PhoneNumber') || getValueByColumn('‡πÄ‡∏ö‡∏≠‡∏£‡πå') || getValueByColumn('Phone') || getValueByColumn('Tel') || '',
          totalBaht: getNumericValueByColumn('Total Baht') || getNumericValueByColumn('TotalBaht') ,
          freeStickers: getIntValueByColumn('Free Stickers') || getIntValueByColumn('FreeStickers') || getIntValueByColumn('‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ü‡∏£‡∏µ') || 0,
          paymentSlipURL: getValueByColumn('Payment Slip URL') ,
          coreTeam: getValueByColumn('Core Team') ,
          coreTeamAmount: getNumericValueByColumn('Core Team') ,
          items: {}
        };

        // Debug column mapping for first few orders
        if (i <= 3) {
          console.log(`üîç Order ${i} Column Mapping Debug:`);
          console.log(`  Timestamp: "${order.timestamp}"`);
          console.log(`  Contact Name: "${order.contactName}"`);
          console.log(`  Batch: "${order.batch}"`);
          console.log(`  Phone Number: "${order.phoneNumber}"`);
          console.log(`  Total Baht: ${order.totalBaht}`);
          console.log(`  Free Stickers: ${order.freeStickers}`);
          console.log(`  Core Team: "${order.coreTeam}"`);
          console.log(`  Core Team Amount: ${order.coreTeamAmount}`);
          
          // Show which columns were actually found
          console.log(`  üìç Column Search Results:`);
          console.log(`    Timestamp found: ${getValueByColumn('Timestamp') || getValueByColumn('Date') || getValueByColumn('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || getValueByColumn('Time')}`);
          console.log(`    Name found: ${getValueByColumn('Contact Name') || getValueByColumn('Name') || getValueByColumn('‡∏ä‡∏∑‡πà‡∏≠') || getValueByColumn('Contact')}`);
          console.log(`    Phone found: ${getValueByColumn('Phone Number') || getValueByColumn('Phone') || getValueByColumn('‡πÄ‡∏ö‡∏≠‡∏£‡πå') || getValueByColumn('Tel')}`);
          console.log(`    Free Stickers found: ${getValueByColumn('Free Stickers') || getValueByColumn('FreeStickers') || getValueByColumn('‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ü‡∏£‡∏µ') || 'NOT FOUND'}`);
        }
        
        // Debug Core Team values for first few orders
        if (i <= 5) {
          console.log(`üîç Order ${i} Core Team Debug:`);
          console.log(`  Raw coreTeam value: "${values[values.length - 3]}"`);
          console.log(`  Raw coreTeamAmount value: "${values[values.length - 2]}"`);
          console.log(`  Parsed coreTeam: "${order.coreTeam}"`);
          console.log(`  Parsed coreTeamAmount: ${order.coreTeamAmount}`);
          console.log(`  Is Core Team (negative): ${order.coreTeamAmount < 0}`);
        }
        
        // Special debug for specific order
        if (order.contactName === "‡πÄ‡∏≠‡∏™‡∏ï‡∏±‡πâ‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏¥‡∏î‡∏î‡∏µ") {
          console.log(`üéØ SPECIAL DEBUG for ‡πÄ‡∏≠‡∏™‡∏ï‡∏±‡πâ‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏¥‡∏î‡∏î‡∏µ:`);
          console.log(`  Row index: ${i}`);
          console.log(`  Total columns in row: ${values.length}`);
          console.log(`  Total columns in headers: ${headers.length}`);
          console.log(`  All raw values:`, values);
          console.log(`  Last 5 values:`, values.slice(-5));
          console.log(`  Core Team column index (values.length - 3): ${values.length - 3}`);
          console.log(`  Core Team Amount column index (values.length - 2): ${values.length - 2}`);
          console.log(`  Raw coreTeam value: "${values[values.length - 3]}"`);
          console.log(`  Raw coreTeamAmount value: "${values[values.length - 2]}"`);
          console.log(`  Parsed coreTeam: "${order.coreTeam}"`);
          console.log(`  Parsed coreTeamAmount: ${order.coreTeamAmount}`);
          console.log(`  Is Core Team (negative): ${order.coreTeamAmount < 0}`);
          console.log(`  Type of coreTeamAmount: ${typeof order.coreTeamAmount}`);
        }
        
        // Parse product quantities (skip known non-product columns)
        let itemCount = 0;
        const knownNonProductColumns = [
          'timestamp', 'contact name', 'batch', 'batch other', 'phone number', 'phonenumber',
          'total baht', 'totalbaht', 'free stickers', 'freestickers', 'payment slip url', 'payment slip url',
          'core team', 'core team amount', 'total', 'summary', '‡∏£‡∏ß‡∏°', '‡∏¢‡∏≠‡∏î', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
          'phone', '‡πÄ‡∏ö‡∏≠‡∏£‡πå', 'tel', 'telephone'
        ];
        
        // Debug: Log which columns are being processed for items
        if (i <= 3) { // Only log for first few orders to avoid spam
          console.log(`üîç Order ${i} - Processing columns for items:`);
        }
        
        for (let j = 0; j < Math.min(headers.length, values.length); j++) {
          const productName = headers[j];
          const quantity = parseInt(values[j]) || 0;
          
          // Debug logging for first few orders
          if (i <= 3) {
            console.log(`  Column ${j}: "${productName}" = ${quantity} (${typeof quantity})`);
          }
          
          // Skip if it's a known non-product column or empty
          if (knownNonProductColumns.some(col => 
              productName.toLowerCase().includes(col.toLowerCase())
          )) {
            if (i <= 3) console.log(`    ‚Üí Skipped (known non-product column)`);
            continue;
          }
          
          // Additional checks for common non-product patterns
          const lowerProductName = productName.toLowerCase();
          if (lowerProductName.includes('phone') || 
              lowerProductName.includes('‡πÄ‡∏ö‡∏≠‡∏£‡πå') || 
              lowerProductName.includes('tel') ||
              // Only exclude free stickers, not actual sticker products
              (lowerProductName.includes('‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ü‡∏£‡∏µ') || lowerProductName === 'freestickers') ||
              lowerProductName.includes('free') ||
              lowerProductName.includes('‡∏ü‡∏£‡∏µ') ||
              lowerProductName.includes('timestamp') ||
              lowerProductName.includes('date') ||
              lowerProductName.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') ||
              lowerProductName.includes('time') ||
              lowerProductName.includes('‡πÄ‡∏ß‡∏•‡∏≤') ||
              lowerProductName.includes('total') ||
              lowerProductName.includes('‡∏¢‡∏≠‡∏î') ||
              lowerProductName.includes('‡∏£‡∏ß‡∏°') ||
              lowerProductName.includes('amount') ||
              lowerProductName.includes('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô') ||
              lowerProductName.includes('quantity') ||
              lowerProductName.includes('batch') ||
              lowerProductName.includes('‡∏£‡∏∏‡πà‡∏ô') ||
              lowerProductName.includes('model') ||
              lowerProductName.includes('name') ||
              lowerProductName.includes('‡∏ä‡∏∑‡πà‡∏≠') ||
              lowerProductName.includes('contact') ||
              lowerProductName.includes('payment') ||
              lowerProductName.includes('‡∏™‡∏•‡∏¥‡∏õ') ||
              lowerProductName.includes('url') ||
              lowerProductName.includes('core') ||
              lowerProductName.includes('team') ||
              // Additional specific exclusions
              lowerProductName === 'phonenumber' ||
              lowerProductName === '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£' ||
              lowerProductName === 'telephone' ||
              lowerProductName === 'mobile' ||
              lowerProductName === '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠') {
            if (i <= 3) console.log(`    ‚Üí Skipped (pattern match)`);
            continue;
          }
          
          // Only add if it's a valid product with quantity > 0
          if (quantity > 0 && productName && productName.trim() !== '') {
            // Additional validation: skip if the product name looks like a phone number or other non-product identifier
            const cleanProductName = productName.replace(/[^a-zA-Z0-9‡∏Å-‡πô]/g, '').toLowerCase();
            
            // Skip if it looks like a phone number (9-10 digits)
            if (/^\d{9,10}$/.test(cleanProductName)) {
              if (i <= 3) console.log(`    ‚Üí Skipped (looks like phone number: ${cleanProductName})`);
              continue;
            }
            
            // Skip if it's just a number or very short text
            if (cleanProductName.length < 3 || /^\d+$/.test(cleanProductName)) {
              if (i <= 3) console.log(`    ‚Üí Skipped (too short or just numbers: ${cleanProductName})`);
              continue;
            }
            
            order.items[productName] = quantity;
            itemCount++;
            if (i <= 3) console.log(`    ‚Üí Added as item: "${productName}" = ${quantity}`);
          } else {
            if (i <= 3) console.log(`    ‚Üí Skipped (no quantity or empty)`);
          }
        }
        
        // Only add orders that have items
        if (Object.keys(order.items).length > 0) {
          orders.push(order);
          successfulRows++;
          if (successfulRows <= 5) { // Log first 5 successful orders
            console.log(`‚úÖ Order ${i}: ${order.contactName || 'NO NAME'} with ${itemCount} items`);
          }
        } else {
          noItemsRows++;
          if (noItemsRows <= 5) { // Log first 5 orders without items
            console.log(`‚ùå Order ${i}: ${order.contactName || 'NO NAME'} - NO ITEMS FOUND`);
            console.log('  Raw values:', values.slice(8, Math.min(headers.length, values.length)));
          }
        }
        
        // If contact name is missing, show raw values for debugging
        if (!order.contactName && i <= 5) {
          console.log(`‚ö†Ô∏è  Order ${i} has NO CONTACT NAME. Raw values:`, values);
          console.log(`    Headers:`, headers);
        }
      }
      
      console.log('=== CSV PARSING SUMMARY ===');
      console.log('Total CSV lines:', lines.length);
      console.log('Header row:', 1);
      console.log('Total data rows in CSV:', totalDataRows);
      console.log('Empty rows skipped:', emptyRows);
      console.log('Rows with insufficient columns:', insufficientColumns);
      console.log('Orders with items (SUCCESS):', successfulRows);
      console.log('Orders without items (SKIPPED):', noItemsRows);
      console.log('Total orders found:', orders.length);
      console.log('Data loss analysis:', `${totalDataRows} CSV rows ‚Üí ${orders.length} orders (${totalDataRows - orders.length} rows lost)`);
      
      // Show which columns were identified as items vs non-items
      if (orders.length > 0) {
        console.log('Sample successful orders:', orders.slice(0, 3));
        
        // Analyze what columns are being treated as items
        const allItemNames = new Set();
        orders.forEach(order => {
          Object.keys(order.items).forEach(itemName => allItemNames.add(itemName));
        });
        
        console.log('üì¶ Items found in orders:', Array.from(allItemNames).sort());
        
        // Show which headers were NOT treated as items (for verification)
        const nonItemHeaders = headers.filter(header => 
          !Array.from(allItemNames).some(itemName => 
            itemName.toLowerCase() === header.toLowerCase()
          )
        );
        console.log('üö´ Headers NOT treated as items:', nonItemHeaders);
      }
      
      console.log('=== CSV PARSING DEBUG END ===');
      
      return orders;
    }

    // Parse CSV row (handle quoted values)
    function parseCSVRow(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current.trim());
      
      // Debug logging for problematic rows
      if (result.length < 5) {
        console.log('‚ö†Ô∏è Warning: Row has very few columns:', result.length);
        console.log('  Original line:', line);
        console.log('  Parsed values:', result);
      }
      
      return result;
    }

    // Generate sample data as fallback
    function generateSampleData() {
      return [
        {
          timestamp: "8/22/2025 20:07:24",
          contactName: "‡∏≠‡∏•‡∏¥‡∏ã‡∏ã‡πà‡∏≤",
          batch: "JTM#25",
          batchOther: "816368018",
          phoneNumber: "2,190",
          totalBaht: 2190,
          freeStickers: 2,
          paymentSlipURL: "https://drive.google.com/file/d/1LNHzkwJ37uJvc3S9xCK_cw7ickMBHmky/view?usp=drivesdk",
          coreTeam: "Core Team",
          coreTeamAmount: 2190,
          items: {
            "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy L": 1,
            "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà White S": 1,
            "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Oversize ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Female 45'' Deep Navy": 1,
            "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡∏ü‡πâ‡∏≤": 1,
            "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ 3 ‡∏™‡∏µ": 1,
            "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 1": 1,
            "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 2": 1
          }
        },
        {
          timestamp: "8/22/2025 20:11:31",
          contactName: "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥",
          batch: "JTM#20",
          batchOther: "819280635",
          phoneNumber: "2,860",
          totalBaht: 2860,
          freeStickers: 2,
          paymentSlipURL: "https://drive.google.com/file/d/1CXIN0vLw8Y7XArbmM0UwiUTnRcjJmyai/view?usp=drivesdk",
          coreTeam: "Core Team",
          coreTeamAmount: -350,
          items: {
            "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Standard ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Deep Navy 2XL": 1,
            "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∏‡∏á‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏á Oversize ‡∏õ‡∏±‡∏Å‡πÇ‡∏•‡πÇ‡∏Å‡πâ - ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà Female 45'' White": 1,
            "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á": 1,
            "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡∏î‡∏≥": 1,
            "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ - ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á": 1,
            "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ - ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß": 1,
            "‡∏´‡∏°‡∏ß‡∏Å Bucket ‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏°": 1,
            "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 1": 1,
            "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 2": 1
          }
        },
        {
          timestamp: "8/22/2025 20:12:00",
          contactName: "‡πÑ‡∏ó‡∏°‡πå ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ",
          batch: "JTM#22",
          batchOther: "867871741",
          phoneNumber: "2,120",
          totalBaht: 2120,
          freeStickers: 2,
          paymentSlipURL: "https://drive.google.com/file/d/1gUdrP0SWuEcDcZN9ZDhyNRrKYcutQcVy/view?usp=drivesdk",
          coreTeam: "",
          coreTeamAmount: 0,
          items: {
            "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡∏î‡∏≥": 1,
            "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ Cross Body ‡∏™‡∏µ‡∏ü‡πâ‡∏≤": 1,
            "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤‡∏ó‡∏£‡∏á‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡πâ‡∏≤‡∏° ‡∏û‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ ‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏™‡∏ß‡∏¢‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö": 2,
            "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ 3 ‡∏™‡∏µ": 1,
            "‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏ö‡∏ú‡πâ‡∏≤‡∏£‡πà‡∏° ‡πÄ‡∏î‡πá‡∏Å‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏™‡πà‡∏î‡∏µ - ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ - ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á": 1,
            "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 1": 2,
            "‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏ñ ‡πÅ‡∏ö‡∏ö 2": 2
          }
        }
      ];
    }

    // Search orders based on filters
    function searchOrders() {
      // Prevent search if data is not loaded yet
      if (allOrders.length === 0) {
        console.log('Search blocked: Data not loaded yet');
        return;
      }
      
      const batchFilter = document.getElementById('batchFilter').value;
      const nameSearch = document.getElementById('nameSearch').value.toLowerCase();
      const coreTeamOnly = document.getElementById('coreTeamFilter').checked;
      
      console.log('üîç Search Debug:');
      console.log('  Batch filter:', batchFilter);
      console.log('  Name search:', nameSearch);
      console.log('  Core Team only:', coreTeamOnly);
      console.log('  Total orders to filter:', allOrders.length);
      
      // Debug Core Team orders before filtering
      if (coreTeamOnly) {
        const coreTeamOrders = allOrders.filter(order => order.coreTeamAmount < 0);
        console.log('  Core Team orders found (coreTeamAmount < 0):', coreTeamOrders.length);
        console.log('  Sample Core Team orders:', coreTeamOrders.slice(0, 3).map(o => ({
          name: o.contactName,
          coreTeamAmount: o.coreTeamAmount,
          batch: o.batch
        })));
      }
      
      filteredOrders = allOrders.filter((order, index) => {
        const matchesBatch = !batchFilter || order.batch === batchFilter;
        const matchesName = !nameSearch || order.contactName.toLowerCase().includes(nameSearch);
        const matchesCoreTeam = !coreTeamOnly || order.coreTeamAmount < 0;
        
        // Debug individual order filtering
        if (coreTeamOnly && index < 5) {
          console.log(`  Order ${order.contactName}: coreTeamAmount=${order.coreTeamAmount}, matchesCoreTeam=${matchesCoreTeam}`);
        }
        
        return matchesBatch && matchesName && matchesCoreTeam;
      });
      
      console.log('  Final filtered orders:', filteredOrders.length);
      
      displayOrders(filteredOrders);
      
      const statusDiv = document.getElementById('statusMessage');
      if (filteredOrders.length === 0) {
        statusDiv.innerHTML = '<div class="error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
      } else {
        statusDiv.innerHTML = '<div class="success">‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ' + filteredOrders.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
      }
    }

    // Clear search filters
    function clearSearch() {
      // Prevent clear if data is not loaded yet
      if (allOrders.length === 0) {
        console.log('Clear search blocked: Data not loaded yet');
        return;
      }
      
      document.getElementById('batchFilter').value = '';
      document.getElementById('nameSearch').value = '';
      document.getElementById('coreTeamFilter').checked = false;
      filteredOrders = allOrders;
      displayOrders(allOrders);
      document.getElementById('statusMessage').innerHTML = '';
    }



    // Display orders in the results section
    function displayOrders(orders) {
      const resultsDiv = document.getElementById('resultsSection');
      
      if (orders.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>';
        return;
      }
      
      let html = '';
      
      orders.forEach((order, index) => {
        html += `
          <div class="order-card">
            <div class="order-header">
              <div class="order-info">
                <div class="order-name">
                  ${order.contactName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ (No Name)'}
                  ${order.coreTeamAmount < 0 ? `<span class="core-team-badge">Core Team ${order.coreTeamAmount.toLocaleString()}</span>` : ''}
                </div>
                <div class="order-details">
                  ‡∏£‡∏∏‡πà‡∏ô: ${order.batch}${order.batchOther ? ' (' + order.batchOther + ')' : ''} | 
                  ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${order.phoneNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | 
                  ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${order.timestamp}
                  ${(order.freeStickers && order.freeStickers > 0) ? ` | ‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ü‡∏£‡∏µ: ${order.freeStickers} ‡∏ä‡∏¥‡πâ‡∏ô` : ''}
                  ${order.paymentSlipURL ? ` | <a href="${order.paymentSlipURL}" target="_blank" style="color: #059669; text-decoration: none; font-weight: 600;">üìÑ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>` : ''}
                </div>
              </div>
              <div class="order-total">${order.totalBaht.toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="order-items">
        `;
        
        // Display items with quantities
        Object.entries(order.items).forEach(([itemName, quantity]) => {
          if (quantity > 0) {
            const product = PRODUCT_CATALOG.find(p => p.name === itemName);
            const image = product ? product.image : 'standard.png';
            
            html += `
              <div class="item-card">
                <div class="item-header">
                  <img src="${image}" alt="${itemName}" class="item-image" onerror="this.src='standard.png'">
                  <div class="item-info">
                    <div class="item-name">${itemName}</div>
                    <div class="item-quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${quantity} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                  </div>
                </div>
              </div>
            `;
          }
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      resultsDiv.innerHTML = html;
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Load data from Google Sheets automatically when page loads
      loadDataFromSheets();
      
      // Add event listeners for real-time search (will be enabled after data loads)
      document.getElementById('nameSearch').addEventListener('input', function() {
        // Only search if controls are enabled and data is loaded
        if (!this.disabled && (this.value.length >= 2 || this.value.length === 0)) {
          searchOrders();
        }
      });
      
      document.getElementById('batchFilter').addEventListener('change', function() {
        // Only search if controls are enabled
        if (!this.disabled) {
          searchOrders();
        }
      });
      
      document.getElementById('coreTeamFilter').addEventListener('change', function() {
        // Only search if controls are enabled
        if (!this.disabled) {
          searchOrders();
        }
      });
    });
  </script>
</body>
</html>
